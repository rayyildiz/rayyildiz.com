---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { isLangPost, isNotDraft } from '../../lib/content';
import { slugifyTerm } from '../../lib/slug';

const posts = (await getCollection('posts')).filter((p) => isLangPost('en', p) && isNotDraft(p));

const counts = new Map<string, { label: string; count: number }>();
for (const p of posts) {
  for (const tag of p.data.tags ?? []) {
    const key = slugifyTerm(tag);
    if (!key) continue;
    const prev = counts.get(key);
    counts.set(key, { label: tag, count: (prev?.count ?? 0) + 1 });
  }
}

const tags = Array.from(counts.entries())
  .map(([slug, v]) => ({ slug, ...v }))
  .sort((a, b) => a.slug.localeCompare(b.slug));
---

<BaseLayout lang="en" title="Tags">
  <h1 class="text-2xl font-semibold">Tags</h1>
  <ul class="mt-6 grid gap-2 sm:grid-cols-2">
    {tags.map((t) => (
      <li>
        <a class="hover:underline" href={`/tags/${t.slug}/`}>{t.label}</a>
        <span class="text-sm text-slate-500"> ({t.count})</span>
      </li>
    ))}
  </ul>
</BaseLayout>
