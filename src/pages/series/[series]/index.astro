---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getPostSlug, isLangPost, isNotDraft, postDateValue } from '../../../lib/content';
import { slugifyTerm } from '../../../lib/slug';

export async function getStaticPaths() {
  const posts = (await getCollection('posts')).filter((p) => isLangPost('en', p) && isNotDraft(p));
  const set = new Set<string>();

  for (const p of posts) {
    for (const s of p.data.series ?? []) {
      const slug = slugifyTerm(s);
      if (slug) set.add(slug);
    }
  }

  return Array.from(set).map((series) => ({ params: { series } }));
}

const seriesSlug = Astro.params.series;
const posts = (await getCollection('posts'))
  .filter((p) => isLangPost('en', p) && isNotDraft(p))
  .filter((p) => (p.data.series ?? []).some((s) => slugifyTerm(s) === seriesSlug));

posts.sort((a, b) => postDateValue(b) - postDateValue(a));
---

<BaseLayout lang="en" title={`Series: ${seriesSlug}`}>
  <h1 class="text-2xl font-semibold">Series: {seriesSlug}</h1>
  <ul class="mt-6 space-y-3">
    {posts.map((p) => (
      <li>
        <a class="text-lg font-medium hover:underline" href={`/posts/${getPostSlug(p)}/`}>{p.data.title}</a>
      </li>
    ))}
  </ul>
</BaseLayout>
